version: "3.3"

services:
  postgres:
    image: postgres:12
    environment:
      POSTGRES_USER: canvas
      POSTGRES_PASSWORD: canvas
      POSTGRES_DB: canvas_production
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:latest

  canvas:
    image: instructure/canvas-lms:stable
    depends_on:
      - postgres
      - redis
    environment:
      CANVAS_LMS_DB_HOST: postgres
      CANVAS_LMS_DB_USERNAME: canvas
      CANVAS_LMS_DB_PASSWORD: canvas
      CANVAS_LMS_DB_NAME: canvas_production
      REDIS_URL: redis://redis:6379
    ports:
      - "3000:3000"
    command: bash -c "
      bundle exec rake db:initial_setup &&
      bundle exec rails s -b 0.0.0.0
    "

volumes:
  postgres_data:
